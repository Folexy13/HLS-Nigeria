import re
import os
from django.utils import timezone
import json
from decimal import Decimal
from NT_gallery.models import Product
from NT_gallery.models import LSV
from NT_gallery.models import Flag_condition
from datetime import datetime


age_categories = {
    'infant': {'male': ['Cryptorchidism', 'Hypospadias'], 
                'female': ['Congenital heart defects', 'Respiratory distress syndrome']},
    'child': {'male': ['ADHD', 'Autism'], 
               'female': ['Juvenile idiopathic arthritis', 'Pediatric asthma']},
    'teen': {'male': ['Acne', 'Sports-related injuries'], 
              'female': ['Menstrual disorders', 'Eating disorders']},
    'young_adult': {'male': ['Hypertension', 'Testicular cancer'], 
                       'female': ['Polycystic ovary syndrome', 'Endometriosis']},
    'adult': {'male': ['Prostate cancer', 'Cardiovascular disease'], 
               'female': ['Breast cancer', 'Osteoporosis']},
    'menopausal': {'female': ['Hot flashes', 'Vaginal dryness']},
    'aged': {'male': ['Prostate enlargement', 'Age-related macular degeneration'], 
              'female': ['Dementia', 'Urinary incontinence']},
    'male (50-60)': {'male': ['Benign prostatic hyperplasia', 'Age-related erectile dysfunction',
                               'Prostate fibrosis', 'Testicular atrophy']}
}


# Load products JSON data
with open('NT_gallery/fixtures/data.json') as f:
    products_data = json.load(f)

def clean_price(price):
    # Check if the price is a string
    if isinstance(price, str):
        # Remove the Naira sign
        price = price.replace('â‚¦', '').replace('₦', '')
        
        # Remove any commas
        price = price.replace(',', '')
        
        # Check if the price is empty
        if price.strip() == '':
            return None
        
        # Check if the price is a range
        if '-' in price:
            # Split the price range into min and max prices
            prices = price.split('-')
            min_price = Decimal(prices[0].strip())
            max_price = Decimal(prices[1].strip())
            
            # Calculate the average price
            avg_price = (min_price + max_price) / 2
            return avg_price
        else:
            # Return the price as a Decimal
            return Decimal(price)
    else:
        # Return the price as is (already a Decimal)
        return price

for product in products_data:
    print(f"{product['name']}-{clean_price(product['price'])}")     


dbproducts = Product.objects.all()
for dbproduct in dbproducts:
    print(f"{dbproduct.name}-{clean_price(dbproduct.price)}")


for dbproduct in dbproducts:
    print(f"{dbproduct.name}-{dbproduct.id}")

for product in products_data:
    dbproduct = Product.objects.filter(name=product['name']).first()
    if dbproduct:
        cleaned_price = clean_price(product['price'])
        if cleaned_price is not None:
            dbproduct.price = cleaned_price
            dbproduct.save()
            print(f"Updated price for {dbproduct.name} to {dbproduct.price}")
        else:
            print(f"No price found for {product['name']}")
    else:
        print(f"Product '{product['name']}' not found in the database.")


# Loop through each product
for product in products_data:
    age = 'adult'  
    gender = product['sub_categories']['gender']
    flag_condition_objs = []
    if 'male' in gender:
        flag_condition_objs.extend(age_categories[age]['male'])
    if 'female' in gender:
        flag_condition_objs.extend(age_categories[age]['female'])
    if 'pictures' in product and 'main_image' in product['pictures']:
        old_path = product['pictures']['main_image']
        new_path = old_path.replace('/blog_images/', 'product_image/')
        product['pictures']['main_image'] = new_path
    product['sub_categories']['age'] = [age]
    price_str = product['price']
    product['price'] = clean_price(price_str)
    lsv_objs = []
    for lsv in product['lsvs']:
        lsv_obj, created = LSV.objects.get_or_create(name=lsv['name'])
        lsv_objs.append(lsv_obj)
    product_obj, created = Product.objects.get_or_create(
        name=product['name'],
        category=product['category'],
        sub_categories=product['sub_categories'],
        price=product['price'],
        strength=product['strength'],
        description=product['description'],
        pictures=product['pictures']
    )
    flag_condition_instances = []
    for condition in flag_condition_objs:
        flag_condition_instance, created = Flag_condition.objects.get_or_create(name=condition)
        flag_condition_instances.append(flag_condition_instance)
    product_obj.flag_condition.set(flag_condition_instances)
    product_obj.lsvs.set(lsv_objs)
    product_obj.save()


    ----------------------------------------------------------------------------------------
    for lifestyle

with open('NT_gallery/fixtures/lifestyledata.json', 'w') as f:
    json.dump(data, f, indent=4)


    def load_products_from_json(file_path):
    with open('NT_gallery/fixtures/lifestyledata.json') as f:
        data = json.load(f)

    for product_data in data:
        sub_categories = {
            'age': product_data['sub_categories']['age'],
            'brands': product_data['sub_categories']['brands'],
            'gender': product_data['sub_categories']['gender'],
            'Lifestyle': product_data['sub_categories']['Lifestyle'],
            'Dosage Forms': product_data['sub_categories']['Dosage Forms'],
            'Lifestyle Rating': product_data['sub_categories']['Lifestyle Rating'],
            'pharmacy grouping': product_data['sub_categories']['pharmacy grouping'],
        }

        product, created = Product.objects.get_or_create(
            name=product_data['name'],
            defaults={
                'category': product_data['main_category'],
                'sub_categories': sub_categories,
                'description': product_data['description'],
                'pictures': product_data['pictures'],
            }
        )

        if created:
            print(f"Product '{product.name}' created successfully.")
        else:
            print(f"Product '{product.name}' already exists.")

        if not created:
            product.category = product_data['main_category']
            product.sub_categories = sub_categories
            product.description = product_data['description']
            product.pictures = product_data['pictures']
            product.save()

# Usage
load_products_from_json('products.json')

for product in data:
    if product['sub_categories']['brands']==['N/F'] or product['sub_categories']['brands']==["Nature's Formula"]:
        print(product['sub_categories']['brands'])
        product['sub_categories']['brands'] = "Nature's Field"

for product in data:
    if product['name']=="Calcium":
        print(product['sub_categories']['brands'])

# Delete existing products
Product.objects.all().delete()

# Load JSON data
with open('NT_gallery/fixtures/healthcondition.json', 'r') as f:
    data = json.load(f)

# Create products
for product_data in data:
    price = product_data.get('price')
    if price is not None and price != '':
        try:
            price = Decimal(float(price))
        except (ValueError, decimal.InvalidOperation):
            price = None
    else:
        price = None
    product = Product(
        name=product_data['name'],
        category=product_data['category'],
        sub_categories=product_data['sub_categories'],
        price=price,
        strength=product_data['strength'],
        description=product_data['description'],
        main_image=product_data['main_image'],
    )
    product.save()
    
    # Add LSVs
    for lsv in product_data['lsvs']:
        # Assuming LSV is a model with a name field
        lsv_obj, _ = LSV.objects.get_or_create(name=lsv)
        product.lsvs.add(lsv_obj)
        
    # Add flag conditions
    for flag_condition in product_data['flag_condition']:
        # Assuming FlagCondition is a model with a name field
        flag_condition_obj, _ = Flag_condition.objects.get_or_create(name=flag_condition)
        product.flag_condition.add(flag_condition_obj)


import json

# Load JSON data
with open('your_file.json', 'r') as f:
    data = json.load(f)

# Loop over each product
for product in data:
    sub_categories = product['sub_categories']
    
    # Check if 'pharmacy_grouping' key exists
    if 'pharmacy_grouping' in sub_categories:
        # Add value to 'pharmacy grouping' list
        if 'pharmacy grouping' not in sub_categories:
            sub_categories['pharmacy grouping'] = []
        sub_categories['pharmacy grouping'].append(sub_categories['pharmacy_grouping'])
        
        # Delete 'pharmacy_grouping' key
        del sub_categories['pharmacy_grouping']

# Save updated JSON data
with open('your_file.json', 'w') as f:
    json.dump(data, f, indent=4)

------------------------------------------------------------------------------------------------
with open('NT_gallery/fixtures/condition.json') as f:
    data = json.load(f)


def load_products(json_file_name):
    try:
        with open(f'NT_gallery/fixtures/{json_file_name}condition.json', 'r') as f:
            data = json.load(f)
    except json.JSONDecodeError as e:
        print(f"Error loading JSON: {e}")
        return
    added_products = []
    for product_data in data:
        price = product_data.get('price')
        if price is not None and price != '':
            try:
                price = Decimal(float(price))
            except (ValueError, Decimal.InvalidOperation):
                price = None
        else:
            price = None
        product = Product(
            name=product_data['name'],
            category=product_data['category'],
            sub_categories=product_data['sub_categories'],
            price=price,
            strength=product_data['strength'],
            description=product_data['description'],
            main_image=product_data['main_image'],
        )
        try:
            product.save()
            added_products.append(product.name)
        except Exception as e:
            print(f"Error saving product: {e}")
            continue
        # Add LSVs
        for lsv in product_data['lsvs']:
            lsv_obj, _ = LSV.objects.get_or_create(name=lsv)
            product.lsvs.add(lsv_obj)
        # Add flag conditions
        for flag_condition in product_data['flag_condition']:
            flag_condition_obj, _ = Flag_condition.objects.get_or_create(name=flag_condition)
            product.flag_condition.add(flag_condition_obj)
    print("Added Products:")
    for product in added_products:
        print(product)
    print('-------------------------------------------------------------------')

# Usage
load_products(json_file_name)



file_names = [
    'respiratory',
    'reproductive',
    'nerve',
    'hormone',
    'eye',
    'digestive',
    'brain',
    'bones_joint',
    'blood'
]

for file_name in file_names:
    print(f"Loading products for {file_name}...")
    load_products(file_name)
    print(f"Done loading products for {file_name}.\n")


-----------------PRINT SUPPLEMENT WITH MULTIPLE APPEARANCES-----------------------------
supplements that appear in multiple JSON files
supplements_in_multiple_files = {}

# Loop through every JSON file in the fixtures directory
for filename in os.listdir('NT_gallery/fixtures'):
    if filename.endswith('.json'):
        # Open the JSON file and load its data
        with open(os.path.join('NT_gallery/fixtures', filename), 'r') as file:
            data = json.load(file)
        # Print the name of the JSON file as the header
        print(f"{filename[:-5]}:")
        for supplement in data:
            # Print the name of the supplement
            print(supplement['name'])
            # Check if the supplement appears in multiple JSON files
            if supplement['name'] in supplements_in_multiple_files:
                supplements_in_multiple_files[supplement['name']]['filenames'].append(filename)
            else:
                supplements_in_multiple_files[supplement['name']] = {
                    'description': supplement['description'],
                    'filenames': [filename]
                }
        print()  # Empty line for better readability

# Print supplements that appear in multiple JSON files
print("Supplements that appear in multiple JSON files:")
for supplement, info in supplements_in_multiple_files.items():
    if len(info['filenames']) > 1:
        print(f"{supplement}:")
        print(f"Description: {info['description']}")
        print(f"Appears in: {', '.join(info['filenames'])}")
        print()  # Empty line for better readability



-----------------PRINT ALL SUPPLEMENTS AND THEIR BRAND NAMES-------------------------------
unique_supplements = []
# Loop through every JSON file in the fixtures directory
for filename in os.listdir('NT_gallery/fixtures'):
    if filename.endswith('.json'):
        # Open the JSON file and load its data
        with open(os.path.join('NT_gallery/fixtures', filename), 'r') as file:
            data = json.load(file)
        # Add each supplement's name to the list
        for supplement in data:
            if supplement['name'] not in [s['name'] for s in unique_supplements]:
                unique_supplements.append(supplement)

for supplement in unique_supplements:
    print(f'{supplement['name']}----{supplement['sub_categories']['brands']}')


---------------------------PRINT ONLY SUPPLEMENTS WITHOUT BRAND NAMES-------------
unique_supplements = []

# Loop through every JSON file in the fixtures directory
for filename in os.listdir('NT_gallery/fixtures'):
    if filename.endswith('.json'):
        # Open the JSON file and load its data
        with open(os.path.join('NT_gallery/fixtures', filename), 'r') as file:
            data = json.load(file)
        for supplement in data:
            if ('sub_categories' not in supplement or 'brands' not in supplement['sub_categories'] or not supplement['sub_categories']['brands']) and supplement['name'] not in [s['name'] for s in unique_supplements]:
                unique_supplements.append(supplement)

for supplement in unique_supplements:
    print(f"{supplement['name']}----{supplement.get('sub_categories', {}).get('brands', 'No brand')}")


fixtures = 'NT_gallery/fixtures'
for filename in os.listdir(fixtures):
    if filename.endswith('.json'):
        with open(os.path.join(fixtures, filename), 'r') as file:
            data = json.load(file)
        print(f"{filename[:-5]}:")
        for supplement in data:
            name = supplement.get('name')
            if name in supplement_brands:
                supplement['sub_categories']['brands'] = [supplement_brands[name]]
                print(f"Fixed brand for {name} to {supplement_brands[name]}")
            else:
                supplement['sub_categories']['brands'] = ['Unavailable']
                print(f"No brand found for {name}. Set to 'Unavailable'")
        print(f"Brands fixed in {filename}\n")
        with open(os.path.join(fixtures, filename), 'w') as f:
            json.dump(data, f, indent=4)
----------------------------------------------------------------------------------------

Reset prices for each

fixtures = 'NT_gallery/fixtures'
for filename in os.listdir(fixtures):
    if filename.endswith('.json'):
        with open(os.path.join(fixtures, filename), 'r') as file:
            data = json.load(file)
        for supplement in data:
            supplement['price'] = 0.0
        with open(os.path.join(fixtures, filename), 'w') as f:
            json.dump(data, f, indent=4)


fixtures = 'NT_gallery/fixtures'

for filename in os.listdir(fixtures):
    if filename.endswith('.json'):
        with open(os.path.join(fixtures, filename), 'r') as file:
            data = json.load(file)
        for supplement in data:
            name = supplement.get('name')
            if name in pharmacy_grouping:
                supplement['sub_categories']['pharmacy grouping'] = [pharmacy_grouping[name]]
                print(f"Supplement: {supplement['name']}--->{supplement['sub_categories']['pharmacy grouping']}")
                print(f"grouping fixed in {filename}\n")
        with open(os.path.join(fixtures, filename), 'w') as f:
            json.dump(data, f, indent=4)


unmatched_supplements = []
for item in data:
    name = item.get('name')
    pharmacy_grouping = item.get('pharmacy grouping')
    if isinstance(pharmacy_grouping, list):
        pharmacy_grouping_str = ', '.join(pharmacy_grouping)
    else:
        pharmacy_grouping_str = pharmacy_grouping
    
    if pharmacy_grouping_str not in pharmacy_grouping_classes:
        unmatched_supplements.append((name, pharmacy_grouping_str))

if unmatched_supplements:
    print("Supplements whose pharmacy grouping does not contain any of the above pharmacy grouping class:")
    for supplement, pharmacy_grouping in unmatched_supplements:
        print(f"{supplement}: {pharmacy_grouping}")